---
status: 待审核
version: 1.1
last_updated: 2026-01-28
reviewer: 用户
---

# 钱包登录注册 - 需求设计（补充：登录后流程）

> 补充钱包登录/绑定后的完整用户流程设计

---

## 十、登录后流程设计

### 10.1 入口与页面跳转规则

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                           登录/绑定后页面跳转规则                            │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  【统一规则】所有登录/绑定场景完成后，均跳转到首页 (/)                       │
│                                                                             │
│  • 钱包登录成功 ──▶ 跳转首页                                                 │
│  • 游客绑定钱包成功 ──▶ 跳转首页                                             │
│  • 钱包断开连接 ──▶ 跳转首页                                                 │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 10.2 各页面可用操作

#### 首页 (Home)

| 用户状态       | 可见元素                                    | 可执行操作                             |
| -------------- | ------------------------------------------- | -------------------------------------- |
| **未登录**     | Connect Wallet 按钮、Start Game 按钮        | 连接钱包、游客进入                     |
| **游客已登录** | 用户信息卡片（昵称+积分）、Bind Wallet 入口 | 进入游戏、绑定钱包、浏览房间、创建房间 |
| **钱包已登录** | 钱包地址显示（截断）、积分余额              | 进入游戏、领取空投、浏览房间、创建房间 |

#### 游戏页 (Game)

| 用户状态       | Header 显示                           | 可执行操作                       |
| -------------- | ------------------------------------- | -------------------------------- |
| **游客模式**   | 昵称、积分、「Bind Wallet」按钮       | 狩猎、聊天、查看排行榜、绑定钱包 |
| **钱包已绑定** | 钱包地址（截断）、积分、✅ 已绑定标识 | 狩猎、聊天、查看排行榜、领取空投 |

#### 领取空投页面 / 弹窗 (Withdraw/Airdrop)

| 用户状态       | 显示内容                         | 可执行操作   |
| -------------- | -------------------------------- | ------------ |
| **未绑定钱包** | 提示绑定钱包 + 绑定按钮          | 绑定钱包     |
| **已绑定钱包** | 积分余额、空投领取记录、领取按钮 | 申请空投领取 |

---

### 10.3 详细用户流程

#### 流程 A: 新用户钱包登录

```
●─▶ 首页 ─▶ 点击「Connect Wallet」─▶ 弹出钱包选择器
        │
        ▼
    选择 Phantom/Solflare ─▶ 钱包弹出授权
        │
        ▼
    确认授权 ─▶ 自动弹出签名请求
        │
        ▼
    确认签名 ─▶ 后端验证 ─▶ 创建用户 ─▶ 生成 Session
        │
        └──▶ isNewUser = true ─▶ **自动跳转 /game**
```

#### 流程 B: 老用户钱包登录

```
●─▶ 首页 ─▶ 点击「Connect Wallet」─▶ 钱包已连接（如浏览器有缓存）
        │
        └──▶ 自动触发签名验证 ─▶ 恢复历史数据
                │
                └──▶ isNewUser = false ─▶ **停留首页**
                            │
                            └──▶ 用户可选择：进入游戏 / 浏览房间 / 领取空投
```

#### 流程 C: 游客绑定钱包

```
●─▶ 首页 ─▶ 点击「Start Game」─▶ 以游客身份进入 /game
        │
        ▼
    游玩累积积分 ─▶ 点击 Header「Bind Wallet」按钮
        │
        ▼
    弹出绑定钱包弹窗 ─▶ 点击「Connect Wallet」
        │
        ▼
    选择钱包 ─▶ 签名验证 ─▶ 调用 /user/bind-wallet
        │
        ├──▶ 成功 ─▶ 显示 Toast「Wallet Bound! You're eligible for airdrops」
        │           └──▶ **停留当前游戏页**
        │
        └──▶ 失败（钱包已被绑定）─▶ 显示错误提示
```

#### 流程 D: 领取空投

```
●─▶ 首页/游戏页 ─▶ 点击「Claim Airdrop」或「💰」按钮
        │
        ├──▶ 未绑定钱包 ─▶ 弹出绑定钱包弹窗 ─▶ 先完成绑定
        │
        └──▶ 已绑定钱包 ─▶ 弹出空投领取弹窗
                    │
                    ├──▶ 显示可领取积分数量
                    │
                    ├──▶ 显示目标钱包地址
                    │
                    └──▶ 点击「Claim」─▶ 调用后端 API
                                │
                                └──▶ 成功 ─▶ 更新余额 ─▶ 显示成功提示
```

---

### 10.4 状态变更时机

| 事件         | 触发动作                | UI 更新                                          |
| ------------ | ----------------------- | ------------------------------------------------ |
| 钱包连接成功 | 无（等待签名）          | 按钮变为「Sign to Login」                        |
| 签名验证成功 | 登录/注册完成           | 显示钱包地址，更新用户信息                       |
| 绑定钱包成功 | 更新用户 wallet_address | Header 显示 ✅ 已绑定，按钮变为「Claim Airdrop」 |
| 钱包断开连接 | 触发 logout             | 清除 session，返回未登录状态                     |
| 切换钱包账户 | 自动 logout             | 清除当前用户，提示重新登录                       |

---

### 10.5 错误处理与 Toast 提示

| 场景                 | 提示类型 | 提示内容                                             |
| -------------------- | -------- | ---------------------------------------------------- |
| 签名被用户取消       | Warning  | "Signature cancelled. Please try again."             |
| 签名验证失败         | Error    | "Invalid signature. Please reconnect wallet."        |
| Nonce 过期           | Warning  | "Session expired. Retrying..." + 自动重试            |
| 钱包已被其他账户绑定 | Error    | "This wallet is already bound to another account."   |
| 绑定成功             | Success  | "🎉 Wallet bound! You're now eligible for airdrops." |
| 网络错误             | Error    | "Network error. Please check your connection."       |

---

## 十一、内部讨论记录（补充）

### 讨论主题：钱包登录后应该跳转到哪个页面？

**产品经理**：新用户应该直接进入游戏体验，减少路径损耗。老用户可能想先看看有什么变化。

**架构师**：可以通过 `isNewUser` 字段判断，新用户跳转游戏，老用户停留首页给他选择权。

**测试工程师**：需要测试自动跳转是否会打断用户的预期操作，比如用户原本想创建房间。

**用户代言人**：新用户直接进入游戏是好的，降低决策成本。老用户停留首页合理，他们已经熟悉流程。

**最终决策**：

- **新用户（isNewUser=true）**：自动跳转游戏页
- **老用户**：停留首页，让用户自主选择
- **游客绑定钱包**：停留当前页面，不跳转
- **游客绑定钱包**：自动跳转首页

---

## 十二、假设清单（补充）

| #   | 假设                       | 状态        |
| --- | -------------------------- | ----------- |
| 6   | 钱包登录成功后跳转首页     | ✅ 用户确认 |
| 7   | 游客绑定钱包成功后跳转首页 | ✅ 用户确认 |
| 8   | 钱包断开时跳转首页         | ✅ 用户确认 |

---

## 变更记录

| 日期       | 内容                              |
| ---------- | --------------------------------- |
| 2026-01-28 | 初版需求设计                      |
| 2026-01-28 | 补充登录后流程设计（第十~十二节） |
