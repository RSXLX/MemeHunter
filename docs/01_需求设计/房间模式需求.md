---
status: 草稿
version: 1.1
last_updated: 2026-01-21
reviewer: 用户
---

# MemeHunter 房间模式 (Real Token Pools) 需求设计

> 本文档基于用户反馈更新：**必须接入真实 DEX (如 Jupiter/Raydium)**，允许房主使用 SOL 兑换指定 Meme 代币作为房间奖池。

---

## 一、 核心业务流程 (Updated)

### 1.1 创建房间 (Create Room with Swap)
**前置**: 用户连接钱包，持有 SOL。
**流程**:
1. **选择猎物 (Token)**: 用户输入或选择目标 Token (如 BONK, WIF)。
2. **投入本金**: 用户输入投入的 SOL 金额 (如 1 SOL)。
   - *前端动作*: 调用 **Jupiter API** 查询 1 SOL 能兑换多少 BONK。
3. **设置参数**:
   - 房间时长 (如 1h)。
   - 捕网费率 (如 0.01 SOL/次，**注意**: 网费通常还是收 SOL，因作为 Gas 和收入更方便)。
4. **一键创建 (Bundle Tx)**:
   - **Step 1**: Swap SOL -> BONK (通过 Jupiter 路由)。
   - **Step 2**: 调用合约 `InitializeRoom`，将 Swap 得到的 BONK 存入 **Room Token Vault** (PDA)。
   - *注*: 这一步需要前端组合 Instruction，实现无缝体验。

### 1.2 自动化分布 (Distribution)
**定义**: "自动去交易一些 meme 回来当成游动的 meme"
**实现**: 
- 房间创建时，池子里已经是真实的 Meme 代币 (如 1,000,000 BONK)。
- 系统将这 1M BONK 分配给场上的虚拟实体。
- **捕获成功时**: 合约直接从 Vault 转账 BONK 给玩家 (SPL Transfer)。
  - *例*: 捕获一只 "金狗"，获得 1,000 BONK。

### 1.3 游戏结算 (Settle)
- **触发**: 时间到 或 资金空。
- **退款**: 剩余的 BONK 全部转回给房主。
- **网费收益**: 玩家支付的 SOL 网费转给房主。

---

## 二、 详细功能需求

### 2.1 房主体验
- **代币选择器**: 集成 Jupiter Token List，支持搜索热点 Meme。
- **预估计算**: 显示 "1 SOL ≈ 50,000 WIF"，即奖池深度。
- **收益面板**: 显示 "投入 1 SOL (换成 WIF) / 收回 0.2 SOL (网费) + 剩余 WIF"。

### 2.2 玩家体验
- **房间标签**: 显示该房间产出的代币 (如 "BONK 房", "WIF 房")。
- **真实收益**: 捕获后，钱包里直接增加对应的 SPL Token。
- **多代币支持**: 玩家可能在一局游戏里获得多种币 (如果未来支持混合池)。*MVP 建议单币池*。

---

## 三、 技术架构变更

### 3.1 智能合约 (Solana BPF)
- **新增依赖**: `spl-token` crate。
- **Room Account**:
  - `token_mint`: 记录该房间产出什么币。
  - `token_vault`: 存放代币的 Token Account (PDA)。
  - `creator`: 房主地址。
- **指令变更**:
  - `InitializeRoom`: 需接收 `Mint` 地址，创建 ATA。
  - `Hunt`: 需传入 `Token Program`, `Room Vault`, `Player ATA`，执行 `transfer`。

### 3.2 前端 (React)
- **DEX 集成**: 集成 Jupiter V6 API (或是 Raydium SDK)。
  - 用于获取报价 (Quote)。
  - 用于构建 Swap Transaction。
- **组合交易**: 将 `Jupiter Swap` 的 Instruction 和 `MemeHunter Initialize` 的 Instruction 塞进同一个 Transaction 发送。保证"要么全成功，要么全失败" (原子性)，防止币换了但房间没建成。

---

## 四、 风险评估

1. **SPL Token 租金**: 每个房间都需要创建一个 Token Vault (ATA)，需要支付 rent (~0.002 SOL)。由房主支付。
2. **滑点保护**: 创建房间时 Swap 可能因滑点失败。前端需设置合理的 Slippage (如 1%)。
3. **恶意 Token**: 用户可能创建 "Scam Token" 房。
   - *对策*: 前端通过 Jupiter Verified List 过滤，或在列表中标记 "Unverified"。

---

## 五、 内部讨论记录 (AI 模拟)

**架构师**: 引入 SPL Token 后，BPF 合约复杂度增加。我们需要处理 CPI (Cross-Program Invocation) 调用 SPL Token Program。
**产品经理**: 这才是 Web3 游戏的精髓——"Play to Earn Real Crypto"。用户不想要假分。
**开发**: Jupiter 集成在前端做比较简单，合约只负责收钱和发钱。
**决策**:
- **前端**: 负责 Swap (SOL -> Token)。
- **合约**: 负责 Hold (Vault) 和 Distribute (Transfer)。
- **不**在合约内做 Swap (太复杂且昂贵)。

---

## 六、 变更对比

| 特性 | 原方案 (纯 SOL) | 新方案 (Real Token) |
|------|-----------------|---------------------|
| **资产** | 仅 SOL | 任意 SPL Token (BONK, WIF...) |
| **创建** | 直接转账 SOL | Swap SOL->Token 再转入合约 |
| **奖励** | SOL | SPL Token |
| **依赖** | System Program | System + SPL Token + Associated Token |

