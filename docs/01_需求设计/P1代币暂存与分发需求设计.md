---
status: 已审核
version: 1.1
last_updated: 2026-01-28
reviewer: 用户
---

# P1: 代币暂存与分发机制 - 需求设计

> 房主充值代币到合约暂存，游戏结束时按积分分发空投

---

## 一、业务流程

```
房主创建房间 → 充值代币(SOL/SPL)到合约
    ↓
玩家加入游戏 → 捕获 Meme 赚取积分
    ↓
房间结束（两种方式）→ 代币分发
```

### 结束方式

| 方式     | 触发             | 结果                 |
| -------- | ---------------- | -------------------- |
| 正常结束 | 池子耗尽或时间到 | 按积分比例分发给玩家 |
| 房主停止 | 房主主动关闭     | 剩余代币退回房主钱包 |

---

## 二、用户场景

### 场景 1: 房主创建链上房间

```
房主连接钱包 → 点击「创建房间」
    → 选择代币类型 (SOL 或 SPL Token)
    → 输入充值金额
    → 签名交易 → 代币转入合约
    → 房间创建成功，显示房间链接
```

### 场景 2: 玩家领取空投

```
玩家在房间游戏 → 赚取积分
    → 房间结束 → 系统计算分发比例
    → 玩家点击「Claim」→ 代币发送到钱包
```

### 场景 3: 房主停止房间

```
房主点击「停止房间」
    → 确认弹窗：剩余 X 代币将退回
    → 签名确认 → 代币退回房主钱包
    → 房间状态变为 ended
```

---

## 三、核心规则

### 3.1 代币支持

| 类型         | 说明                                 |
| ------------ | ------------------------------------ |
| SOL (Native) | 原生 SOL                             |
| SPL Token    | 房间指定的 SPL 代币（需 token_mint） |

### 3.2 积分兑换规则

```
玩家可领取代币 = 池总额 × (玩家积分 / 全体玩家总积分)
```

### 3.3 分发时机

| 时机         | 操作                               |
| ------------ | ---------------------------------- |
| 房间正常结束 | 自动计算各玩家份额，玩家手动 claim |
| 房主主动停止 | 剩余代币退回房主                   |

---

## 四、数据变更

### 4.1 rooms 表新增

| 字段              | 类型   | 说明                |
| ----------------- | ------ | ------------------- |
| token_type        | TEXT   | 'SOL' 或 'SPL'      |
| token_mint        | TEXT   | SPL 代币地址 (可空) |
| initial_deposit   | BIGINT | 初始充值金额        |
| remaining_balance | BIGINT | 剩余池余额          |

### 4.2 新增 claims 表

```sql
CREATE TABLE claims (
    id TEXT PRIMARY KEY,
    room_id TEXT,
    user_id TEXT,
    points INTEGER,
    token_amount BIGINT,
    status TEXT DEFAULT 'pending',
    tx_hash TEXT,
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP
);
```

---

## 五、接口设计

### 5.1 结算房间

**POST** `/api/rooms/:id/settle`

```json
// Response
{
  "success": true,
  "claims": [
    { "userId": "xxx", "points": 500, "tokenAmount": "1.5" },
    { "userId": "yyy", "points": 300, "tokenAmount": "0.9" }
  ]
}
```

### 5.2 房主停止并退回

**POST** `/api/rooms/:id/stop`

```json
// Response
{
  "success": true,
  "refundAmount": "10.5",
  "txHash": "..."
}
```

---

## 六、假设清单

| #   | 假设                       | 状态        |
| --- | -------------------------- | ----------- |
| 1   | 房主充值到合约，玩家不充值 | ✅ 用户确认 |
| 2   | 积分按比例兑换代币         | ✅ 用户确认 |
| 3   | 房主可随时停止房间         | ✅ 用户确认 |
| 4   | 停止后剩余代币退回房主     | ✅ 用户确认 |

---

## 变更记录

| 日期       | 内容         |
| ---------- | ------------ |
| 2026-01-28 | 初版需求设计 |
