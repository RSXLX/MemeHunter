---
status: 已完成
version: 1.1
last_updated: 2026-01-28
reviewer: 用户
---

# P0: 空投领取链上实现 + 钱包监听 - 需求设计

> 完善空投领取的链上执行和钱包状态实时监听

---

## 一、现状分析

### 1.1 已有能力

| 模块          | 文件                 | 功能                   | 状态          |
| ------------- | -------------------- | ---------------------- | ------------- |
| Solana Client | `solanaClient.js`    | `claimReward` 链上调用 | ✅ 完成       |
| 提现管理      | `withdrawManager.js` | 申请创建/链上执行      | ✅ 完成       |
| 提现路由      | `withdraw.js`        | POST /withdraw API     | ⚠️ 仅创建申请 |
| 前端弹窗      | `WithdrawModal.tsx`  | 提现表单 UI            | ⚠️ 仅创建申请 |

### 1.2 差距

| 问题                               | 影响                     |
| ---------------------------------- | ------------------------ |
| 前端提现只创建申请，不自动执行链上 | 用户需等待手动处理       |
| 缺少钱包 disconnect 监听           | 断开钱包后用户状态不更新 |
| 缺少账户切换监听                   | 切换钱包后身份混乱       |
| 提现需要指定 roomPda               | 用户不知道当前房间的 PDA |

---

## 二、用户场景

### 场景 1: 用户在房间内领取空投

```
用户在房间 A 赚取积分 → 点击「💰 Claim」
    → 系统检查是否绑定钱包 (未绑定则引导绑定)
    → 显示可领取积分和房间池子余额
    → 用户输入领取金额并确认
    → 后端调用 claimReward(房间PDA, 用户钱包, 金额)
    → 交易成功 → 显示 TX 链接
```

### 场景 2: 钱包断开连接

```
用户正在游戏 → 在钱包扩展中断开
    → 前端检测到 disconnect 事件
    → 自动清除登录状态
    → 跳转首页 + Toast 提示
```

### 场景 3: 用户切换钱包账户

```
用户已用钱包 A 登录 → 在钱包中切换到账户 B
    → 前端检测到 accountChanged 事件
    → 自动登出
    → 提示用户重新登录
```

---

## 三、核心需求

### 3.1 空投领取流程优化

**规则**: 用户只能在当前房间内领取该房间池子的代币

**流程**:

1. 用户在游戏页 (Game.tsx) 点击「💰」领取按钮
2. 弹窗显示当前房间池余额 + 用户积分
3. 用户输入领取金额
4. 前端发送 POST /withdraw/claim {金额, roomId}
5. 后端调用 claimReward(房间PDA, 用户钱包, 代币金额)
6. 返回交易哈希

### 3.2 钱包状态实时监听

**目标**: 实时响应钱包连接状态变化

**事件**:

- `disconnect`: 断开连接 → 登出 + 跳转首页
- `accountChanged`: 切换账户 → 登出 + 提示重新登录

---

## 四、接口设计

### 4.1 新增: 立即领取接口

**POST** `/api/withdraw/claim`

```json
// Request
{
  "roomId": "room-uuid",  // 必填：当前房间 ID
  "amount": 500           // 领取积分数量
}

// Response (成功)
{
  "success": true,
  "txHash": "5xK4t...abc",
  "amount": 500,
  "tokenAmount": "0.500000",
  "explorerUrl": "https://explorer.solana.com/tx/5xK4t...abc?cluster=devnet"
}

// Response (失败)
{
  "success": false,
  "error": "Insufficient balance",
  "code": "INSUFFICIENT_BALANCE"
}
```

### 4.2 错误码

| 错误码               | 说明         |
| -------------------- | ------------ |
| WALLET_NOT_BOUND     | 未绑定钱包   |
| INSUFFICIENT_BALANCE | 余额不足     |
| NO_ACTIVE_ROOM       | 无活跃房间   |
| CHAIN_ERROR          | 链上交易失败 |

---

## 五、代码变更清单

### 5.1 后端

| 文件                          | 变更                      |
| ----------------------------- | ------------------------- |
| [MODIFY] `withdraw.js`        | 新增 `/claim` 路由        |
| [MODIFY] `withdrawManager.js` | 新增自动查找 roomPda 逻辑 |

### 5.2 前端

| 文件                         | 变更                                |
| ---------------------------- | ----------------------------------- |
| [MODIFY] `useWalletAuth.ts`  | 添加 disconnect/accountChanged 监听 |
| [MODIFY] `WithdrawModal.tsx` | 改为调用 /claim 接口，显示交易结果  |
| [NEW] `useWalletEvents.ts`   | 钱包事件监听 Hook                   |

---

## 六、假设清单

| #   | 假设                                        | 状态        |
| --- | ------------------------------------------- | ----------- |
| 1   | 用户只能在当前房间内领取该房间的池子        | ✅ 用户确认 |
| 2   | 积分:代币 = 1000:1 (已在 solanaClient 配置) | ✅ 已实现   |
| 3   | 钱包断开时自动登出并跳转首页                | ✅ 用户确认 |

---

## 七、验证计划

1. **链上领取**: 用户领取 → 检查 TX → 验证代币到账
2. **断开监听**: 模拟断开钱包 → 验证自动登出
3. **切换监听**: 模拟切换账户 → 验证登出提示

---

## 变更记录

| 日期       | 内容         |
| ---------- | ------------ |
| 2026-01-28 | 初版需求设计 |
