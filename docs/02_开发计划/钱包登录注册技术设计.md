---
status: 待审核
version: 1.0
last_updated: 2026-01-28
reviewer: 用户
---

# 钱包登录注册 - 技术设计

> 实现「游客模式 + 可选钱包绑定」的双轨身份系统

---

## 一、设计概述

### 1.1 核心设计理念

保留现有游客登录体验，新增钱包登录和绑定功能：

```
┌─────────────────────────────────────────────────────────────┐
│                       用户身份系统                          │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│   ┌───────────────────┐       ┌───────────────────┐        │
│   │   游客模式 (现有)   │       │   钱包模式 (新增)   │        │
│   ├───────────────────┤       ├───────────────────┤        │
│   │ • 自动生成昵称     │       │ • 签名验证登录     │        │
│   │ • Session 管理     │  ──▶  │ • 钱包地址绑定     │        │
│   │ • 积分累积        │       │ • 空投领取资格     │        │
│   └───────────────────┘       └───────────────────┘        │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

### 1.2 两种登录路径

| 路径             | 入口                       | 结果                       |
| ---------------- | -------------------------- | -------------------------- |
| **游客进入**     | 直接开始游戏               | 自动创建 session，随机昵称 |
| **钱包登录**     | 点击「连接钱包」           | 签名验证后登录/注册        |
| **游客绑定钱包** | 已登录状态点击「绑定钱包」 | 将钱包地址关联到现有账户   |

---

## 二、业务流程图

### 2.1 游客登录流程（保留现有）

```
┌─────────┐     ┌─────────────┐     ┌─────────────┐
│ 用户访问 │ ──▶ │ 检查 sessionId │ ──▶ │ 存在?        │
└─────────┘     └─────────────┘     └──────┬──────┘
                                          │
                       ┌──────────────────┼──────────────────┐
                       │ 是               │                  │ 否
                       ▼                  │                  ▼
               ┌─────────────┐            │          ┌─────────────┐
               │ 恢复会话    │            │          │ POST /auth/guest │
               └─────────────┘            │          └──────┬──────┘
                       │                  │                  │
                       └──────────────────┼──────────────────┘
                                          ▼
                                  ┌─────────────┐
                                  │ 进入游戏     │
                                  └─────────────┘
```

### 2.2 钱包登录流程（新增）

```
┌─────────────────┐     ┌─────────────────┐     ┌─────────────────┐
│ 点击 Connect     │ ──▶ │ 钱包授权连接     │ ──▶ │ POST /auth/nonce │
│ Wallet          │     │ (Phantom等)     │     │ 获取签名 Nonce    │
└─────────────────┘     └─────────────────┘     └────────┬────────┘
                                                         │
         ┌───────────────────────────────────────────────┘
         ▼
┌─────────────────┐     ┌─────────────────┐     ┌─────────────────┐
│ 构造签名消息     │ ──▶ │ 钱包签名        │ ──▶ │ POST /auth/wallet│
└─────────────────┘     └─────────────────┘     └────────┬────────┘
                                                         │
         ┌───────────────────────────────────────────────┘
         ▼
┌─────────────────────────────────────────────────────────────────┐
│ 后端验证签名 → 查询/创建用户 → 生成Session → 返回用户信息       │
└─────────────────────────────────────────────────────────────────┘
                                                         │
                                                         ▼
                                                 ┌─────────────┐
                                                 │ 进入游戏     │
                                                 └─────────────┘
```

### 2.3 游客绑定钱包流程（新增）

```
┌─────────────────┐     ┌─────────────────┐     ┌─────────────────┐
│ 游客已登录状态   │ ──▶ │ 点击「绑定钱包」  │ ──▶ │ 钱包授权连接     │
└─────────────────┘     └─────────────────┘     └────────┬────────┘
                                                         │
         ┌───────────────────────────────────────────────┘
         ▼
┌─────────────────┐     ┌─────────────────┐     ┌─────────────────┐
│ POST /auth/nonce│ ──▶ │ 钱包签名验证     │ ──▶ │ POST /user/      │
│                 │     │                 │     │   bind-wallet    │
└─────────────────┘     └─────────────────┘     └────────┬────────┘
                                                         │
                               ┌─────────────────────────┼─────────────────────────┐
                               │ 钱包已被其他用户绑定    │                         │ 绑定成功
                               ▼                        │                         ▼
                       ┌─────────────────┐              │                 ┌─────────────────┐
                       │ 返回错误提示    │              │                 │ 更新用户信息    │
                       └─────────────────┘              │                 │ 获得空投资格    │
                                                        │                 └─────────────────┘
```

---

## 三、代码变更清单

### 后端 (server/)

#### [NEW] src/services/walletAuth.js

钱包认证核心服务：

- `generateNonce(walletAddress)` - 生成随机 nonce
- `verifySignature(message, signature, walletAddress)` - 验证 Solana 签名
- `walletLogin(walletAddress, signature, message)` - 钱包登录/注册

#### [MODIFY] src/routes/auth.js

新增路由：

- `POST /auth/nonce` - 获取签名 nonce
- `POST /auth/wallet` - 钱包登录
- `POST /auth/logout` - 登出

#### [MODIFY] src/services/userManager.js

新增方法：

- `getUserByWallet(walletAddress)` - 按钱包地址查询用户
- `createWalletUser(walletAddress)` - 创建钱包用户
- `bindWallet(userId, walletAddress)` - 游客绑定钱包（增强验证）

#### [NEW] src/migrations/add_nonce_fields.js

数据库迁移：

- 新增 `nonce` 字段
- 新增 `nonce_expires_at` 字段
- 为 `wallet_address` 添加唯一索引

---

### 前端 (frontend/src/)

#### [NEW] hooks/useWalletAuth.ts

钱包认证 Hook：

- 钱包连接状态管理
- 签名流程封装
- 登录/绑定逻辑

#### [NEW] components/wallet/WalletLoginButton.tsx

钱包登录按钮组件：

- 显示连接状态
- 处理签名流程
- 错误提示

#### [NEW] components/wallet/BindWalletModal.tsx

绑定钱包弹窗：

- 显示绑定引导
- 签名验证
- 成功/失败反馈

#### [MODIFY] hooks/useGuestAuth.ts

保留现有逻辑，新增：

- `walletAddress` 状态
- `bindWallet()` 方法优化

#### [MODIFY] pages/Home.tsx

- 新增「Connect Wallet」按钮
- 保留游客入口

#### [MODIFY] pages/Game.tsx

- Header 显示钱包状态
- 绑定钱包入口

#### [MODIFY] components/game/WithdrawModal.tsx

- 改为「领取空投」逻辑
- 必须绑定钱包才能领取

#### [MODIFY] config/api.ts

新增类型定义：

- `WalletLoginResponse`
- `NonceResponse`

---

## 四、接口设计

### 4.1 获取 Nonce

```
POST /api/auth/nonce
```

**Request:**

```json
{
  "walletAddress": "5xK4tH...abcdef"
}
```

**Response:**

```json
{
  "success": true,
  "nonce": "abc123xyz789",
  "message": "Welcome to MemeHunter!\n\nThis signature verifies you own this wallet.\n\nWallet: 5xK4tH...abcdef\nNonce: abc123xyz789\nTimestamp: 2026-01-28T03:30:00Z",
  "expiresAt": "2026-01-28T03:35:00Z"
}
```

### 4.2 钱包登录

```
POST /api/auth/wallet
```

**Request:**

```json
{
  "walletAddress": "5xK4tH...abcdef",
  "signature": "base58EncodedSignature...",
  "message": "Welcome to MemeHunter!..."
}
```

**Response:**

```json
{
  "success": true,
  "isNewUser": false,
  "user": {
    "id": "uuid-xxx",
    "nickname": "CryptoHunter123",
    "walletAddress": "5xK4tH...abcdef",
    "balance": 1500,
    "totalEarned": 3200
  },
  "sessionId": "session-uuid-xxx"
}
```

### 4.3 绑定钱包（增强版）

```
POST /api/user/bind-wallet
```

**Request:**

```json
{
  "walletAddress": "5xK4tH...abcdef",
  "signature": "base58EncodedSignature...",
  "message": "Bind wallet to MemeHunter...",
  "mergeBalance": true
}
```

**Response:**

```json
{
  "success": true,
  "user": {
    "id": "uuid-xxx",
    "walletAddress": "5xK4tH...abcdef",
    "balance": 1500
  },
  "airdropEligible": true
}
```

**错误情况:**

```json
{
  "success": false,
  "error": "WALLET_ALREADY_BOUND",
  "message": "This wallet is already bound to another account"
}
```

---

## 五、数据库变更

### 5.1 迁移脚本

```sql
-- 新增 nonce 相关字段
ALTER TABLE users ADD COLUMN nonce TEXT;
ALTER TABLE users ADD COLUMN nonce_expires_at TEXT;

-- 为 wallet_address 添加唯一索引（允许 NULL）
CREATE UNIQUE INDEX IF NOT EXISTS idx_users_wallet_unique
ON users(wallet_address) WHERE wallet_address IS NOT NULL;
```

### 5.2 表结构对比

| 字段             | 类型 | 变更前       | 变更后         |
| ---------------- | ---- | ------------ | -------------- |
| wallet_address   | TEXT | 可空，无约束 | 可空，唯一索引 |
| nonce            | TEXT | -            | 新增，可空     |
| nonce_expires_at | TEXT | -            | 新增，可空     |

---

## 六、安全考虑

### 6.1 签名验证

- 使用 `@solana/web3.js` 的 `nacl.sign.detached.verify` 验证签名
- Nonce 5 分钟过期，防止重放攻击
- 签名消息包含时间戳

### 6.2 钱包地址验证

- 验证 Base58 格式
- 验证长度 32-44 字符
- 后端二次验证

### 6.3 防重复绑定

- 同一钱包只能绑定一个账户
- 数据库唯一索引保护
- 绑定前检查冲突

---

## 七、验证计划

### 7.1 自动化测试

**后端单元测试** (新建 `server/tests/walletAuth.test.js`)

```bash
cd server && npm test -- --grep "walletAuth"
```

测试用例：

- ✅ 生成 Nonce 成功
- ✅ Nonce 5分钟过期
- ✅ 验证有效签名
- ✅ 拒绝无效签名
- ✅ 新钱包自动注册
- ✅ 老钱包恢复登录
- ✅ 绑定成功
- ✅ 重复绑定拒绝

### 7.2 手动验证

**场景 1: 游客流程（验证现有功能未受影响）**

1. 清除浏览器 localStorage
2. 访问 http://localhost:5173
3. 验证自动创建游客账户
4. 进入游戏，验证正常游玩

**场景 2: 钱包登录**

1. 点击首页「Connect Wallet」
2. 选择 Phantom 钱包
3. 在钱包中确认签名
4. 验证登录成功，显示钱包地址

**场景 3: 游客绑定钱包**

1. 以游客身份登录
2. 进入游戏页面
3. 点击「绑定钱包」按钮
4. 完成签名验证
5. 验证钱包地址已绑定

**场景 4: 防重复绑定**

1. 用钱包 A 登录创建账户
2. 新开隐身窗口，以游客登录
3. 尝试绑定钱包 A
4. 验证显示错误提示

---

## 八、实现优先级

| 优先级 | 任务                             | 预估时间 |
| ------ | -------------------------------- | -------- |
| P0     | 后端: walletAuth 服务 + 签名验证 | 2h       |
| P0     | 后端: auth 路由新增              | 1h       |
| P0     | 数据库迁移脚本                   | 30min    |
| P1     | 前端: useWalletAuth Hook         | 2h       |
| P1     | 前端: WalletLoginButton 组件     | 1h       |
| P1     | 前端: Home 页面集成              | 1h       |
| P2     | 前端: BindWalletModal 组件       | 1h       |
| P2     | 前端: Game 页面集成              | 1h       |
| P2     | 前端: WithdrawModal 改为空投领取 | 1h       |

**总计预估: 10.5 小时**

---

## 变更记录

| 日期       | 内容         |
| ---------- | ------------ |
| 2026-01-28 | 初版技术设计 |
