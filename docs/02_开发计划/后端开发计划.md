# MemeHunter 后端开发计划

> **负责人**: 后端开发  
> **预估工时**: 4 天 (约 32h)  
> **模式**: 中心化版本（无链上交互）  
> **状态**: ✅ 已完成

---

## 一、模块概述

后端负责房间管理、游戏状态、用户积分托管、领取申请等核心逻辑。

### 技术栈
- Node.js + Express
- Socket.io (WebSocket)
- SQLite (better-sqlite3)

### 核心变更
- ✅ 中心化积分系统（后端托管）
- ✅ 游客模式支持（无需钱包连接）
- ✅ 领取时绑定 Solana 钱包地址

---

## 二、数据模型

### 用户 (User)
```javascript
{
  id: string,           // UUID
  sessionId: string,    // 游客 Session ID
  nickname: string,     // 自动生成昵称
  walletAddress: string | null,  // Solana 地址（领取时绑定）
  balance: number,      // 托管积分
  totalEarned: number,  // 累计收益
  createdAt: Date,
  updatedAt: Date
}
```

### 房间 (Room)
```javascript
{
  id: string,
  creatorId: string,    // 创建者 User ID
  name: string,
  tokenSymbol: string,  // 代币符号 (展示用)
  poolBalance: number,  // 奖池余额
  config: {
    maxPlayers: number,
    memeCount: number,
    netCosts: [0.005, 0.01, 0.02]
  },
  status: 'active' | 'paused' | 'ended',
  createdAt: Date
}
```

### 领取申请 (WithdrawRequest)
```javascript
{
  id: string,
  userId: string,
  walletAddress: string,  // Solana 地址
  amount: number,
  status: 'pending' | 'processing' | 'completed' | 'failed',
  txHash: string | null,
  createdAt: Date
}
```

---

## 三、API 设计

### 用户 API

| 端点 | 方法 | 描述 | 认证 |
|-----|------|------|------|
| `/api/auth/guest` | POST | 游客登录 | 无 |
| `/api/user/profile` | GET | 获取用户信息 | Session |
| `/api/user/balance` | GET | 获取积分余额 | Session |
| `/api/user/bind-wallet` | POST | 绑定钱包地址 | Session |
| `/api/leaderboard` | GET | 获取排行榜 | 无 |

### 房间 API

| 端点 | 方法 | 描述 |
|-----|------|------|
| `/api/rooms` | GET | 房间列表 |
| `/api/rooms` | POST | 创建房间 |
| `/api/rooms/:id` | GET | 房间详情 |
| `/api/rooms/:id/qrcode` | GET | 获取房间二维码 |
| `/api/rooms/:id/status` | PATCH | 更新房间状态 |

### 领取 API

| 端点 | 方法 | 描述 |
|-----|------|------|
| `/api/withdraw` | POST | 提交领取申请 |
| `/api/withdraw/history` | GET | 领取历史 |
| `/api/withdraw/:id` | GET | 申请详情 |
| `/api/admin/withdraw/pending` | GET | 待处理列表 (管理) |
| `/api/admin/withdraw/:id/process` | POST | 处理申请 (管理) |

---

## 四、开发任务

### Phase 1: 用户系统 (Day 1) ✅

- [x] 创建 `database/db.js` - SQLite 数据库初始化
- [x] 创建 `services/userManager.js` - 用户管理服务
- [x] 实现游客登录（生成 Session）
- [x] 实现用户积分管理
- [x] 创建 `middleware/session.js` - Session 中间件
- [x] 创建 `routes/auth.js` - 认证路由

### Phase 2: 房间系统 (Day 1-2) ✅

- [x] 创建 `services/roomManager.js`
- [x] 实现房间 CRUD
- [x] 二维码生成 (qrcode 库)
- [x] 房间隔离的 Meme 池
- [x] 创建 `routes/room.js`

### Phase 3: WebSocket 更新 (Day 2-3) ✅

- [x] 游客 Session 认证
- [x] 房间隔离广播
- [x] 狩猎结果处理（积分增减）
- [x] Meme 自动补充 + 广播

### Phase 4: 领取系统 (Day 3-4) ✅

- [x] 创建 `services/withdrawManager.js`
- [x] 领取申请校验
- [x] 持久化到数据库
- [x] 创建 `routes/withdraw.js`
- [x] 管理后台接口（手动处理发放）

---

## 五、WebSocket 事件

| 事件 | 方向 | 描述 |
|-----|------|------|
| `guestLogin` | C→S | 游客登录 |
| `loginSuccess` | S→C | 登录成功，返回 session + user |
| `loginError` | S→C | 登录失败 |
| `joinRoom` | C→S | 加入房间 |
| `roomJoined` | S→C | 加入成功 |
| `hunt` | C→S | 狩猎请求 |
| `huntResult` | S→C | 狩猎结果 + 积分变化 |
| `huntResultBroadcast` | S→C | 广播其他玩家的狩猎结果 |
| `balanceUpdate` | S→C | 积分余额更新 |
| `memeRemoved` | S→C | Meme 被移除 |
| `gameState` | S→C | 游戏状态同步 |
| `playerJoin` | S→C | 玩家加入通知 |
| `playerLeave` | S→C | 玩家离开通知 |

---

## 六、交付物

- [x] `database/db.js` - SQLite 数据库
- [x] `services/userManager.js`
- [x] `services/roomManager.js`
- [x] `services/withdrawManager.js`
- [x] `middleware/session.js`
- [x] `routes/auth.js`
- [x] `routes/room.js`
- [x] `routes/withdraw.js`
- [x] 更新 `websocket/gameSync.js`
- [x] 更新 `index.js` 集成新路由
