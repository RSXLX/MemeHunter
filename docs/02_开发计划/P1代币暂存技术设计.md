---
status: 已完成
version: 1.1
last_updated: 2026-01-28
---

# P1: 代币暂存与分发 - 技术设计

> 房主充值代币到链上暂存，房间结束时按积分分发

---

## 一、架构设计

```
┌─────────────┐     ┌─────────────┐     ┌─────────────┐
│   Frontend  │────▶│   Backend   │────▶│  Solana     │
│             │     │             │     │  Contract   │
└─────────────┘     └─────────────┘     └─────────────┘
    创建房间           记录房间           deposit()
    结算/停止          计算分配           claimReward()
                                        refund()
```

---

## 二、数据库变更

### 2.1 rooms 表修改

```sql
-- 新增字段 (已有 token_mint, room_pda, vault_pda)
ALTER TABLE rooms ADD COLUMN token_type TEXT DEFAULT 'SPL';
ALTER TABLE rooms ADD COLUMN initial_deposit BIGINT DEFAULT 0;
ALTER TABLE rooms ADD COLUMN remaining_balance BIGINT DEFAULT 0;
ALTER TABLE rooms ADD COLUMN settled_at DATETIME DEFAULT NULL;
```

### 2.2 新增 claims 表

```sql
CREATE TABLE claims (
    id TEXT PRIMARY KEY,
    room_id TEXT NOT NULL,
    user_id TEXT NOT NULL,
    points INTEGER NOT NULL,
    share_ratio REAL NOT NULL,
    token_amount BIGINT NOT NULL,
    status TEXT DEFAULT 'pending',
    tx_hash TEXT,
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    claimed_at DATETIME DEFAULT NULL,
    FOREIGN KEY (room_id) REFERENCES rooms(id),
    FOREIGN KEY (user_id) REFERENCES users(id)
);
```

---

## 三、接口设计

### 3.1 结算房间

**POST** `/api/rooms/:id/settle`

计算各玩家份额，生成 claims 记录

```javascript
// 计算逻辑
const totalPoints = players.reduce((sum, p) => sum + p.points, 0);
players.forEach((p) => {
  const ratio = p.points / totalPoints;
  const amount = Math.floor(poolBalance * ratio);
  createClaim(roomId, p.userId, p.points, ratio, amount);
});
```

### 3.2 房主停止并退回

**POST** `/api/rooms/:id/stop`

调用合约 refund() 退回剩余代币

### 3.3 玩家领取

**POST** `/api/claims/:id/claim`

调用合约 claimReward() 发放代币

---

## 四、代码变更清单

### 4.1 后端

| 文件                                      | 变更                     |
| ----------------------------------------- | ------------------------ |
| [NEW] `migrations/add_token_fields.js`    | 数据库迁移               |
| [NEW] `migrations/create_claims_table.js` | 创建 claims 表           |
| [MODIFY] `roomManager.js`                 | 添加 settle/stop 方法    |
| [MODIFY] `room.js`                        | 添加 /settle, /stop 路由 |
| [NEW] `claimManager.js`                   | claims 管理服务          |

### 4.2 合约 (已有)

- `claim_reward.rs` - 已实现
- 需新增 `refund.rs` - 退回代币指令

---

## 五、验证计划

1. 创建链上房间 + 充值代币
2. 玩家游戏赚取积分
3. 结算房间 → 验证 claims 生成
4. 玩家领取 → 验证链上转账
5. 房主停止 → 验证代币退回
