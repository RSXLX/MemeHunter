# MemeHunter 合约机制重设计

> **设计日期**: 2026-01-27  
> **状态**: ✅ 已确认

---

## 一、设计背景

### 1.1 原有机制问题

现有合约 `MemeHunter.sol` 采用 **用户付费模式**：
- 每次狩猎需支付 0.005-0.02 ETH（小/中/大网）
- 费用分配：90% 入奖池，10% 给项目方

**与新定位冲突**：系统定位为 **项目方空投工具**，用户应只有获得感，不应有消耗。

### 1.2 新定位

**MemeHunter = 项目方空投 + 游戏化体验**

- 项目方预充奖池，用户免费参与
- 通过游戏机制增加空投的趣味性和传播性
- 用户获得惊喜感，项目方获得曝光和社区增长

---

## 二、核心机制设计

### 2.1 用户参与门槛

| 方式 | 描述 |
|------|------|
| **免费参与** | 无需支付任何代币 |
| **社交任务** | 完成推特关注/转发等任务获取参与资格 |

**实现要点**：
- 后端验证 Twitter 任务完成状态（Twitter API）
- 支持任务类型：关注、转发、点赞

---

### 2.2 发射频率控制（动态冷却）

**机制**：时间冷却，从 **5 秒渐进到 2 秒**

```
初始冷却: 5秒
↓ (每成功捕获一次，冷却减少 0.5秒)
最小冷却: 2秒
```

**可视化设计**：
- 环形进度条显示冷却时间
- 冷却减少时有视觉反馈（发光、粒子效果）
- 显示当前冷却等级（如 "Lv.3 冷却 3.5秒"）

**重置条件**：
- 房间结束后重置
- 玩家离开房间后重置

---

### 2.3 捕网差异化（连击机制）

**取消**：小/中/大网选择  
**新增**：**Combo 连击系统**

| 连击数 | 网等级 | 效果 |
|--------|--------|------|
| 0 | 普通网 | 基础状态 |
| 3 | 银网 | 视觉升级 + 奖励 1.5x |
| 5 | 金网 | 视觉升级 + 奖励 2.0x |
| 10 | 钻石网 | 视觉升级 + 奖励 3.0x |

**规则**：
- 连续成功捕获累计连击数
- 任意一次捕获失败（点击到空白或 Meme 逃脱），连击归零
- 网等级实时变化，伴随华丽的升级动画

---

### 2.4 奖励机制（连击加成 + 稀有度）

#### Meme 稀有度（调整后 - 基于4-7分钟留存目标）

| 稀有度 | 代表 | 出现概率 | 基础奖励倍数 |
|--------|------|----------|--------------|
| 普通 | Pepe, Doge | 50% | 1x |
| 稀有 | Fox | 30% | 3x |
| 史诗 | Diamond | 15% | 8x |
| 传说 | Rocket | 5% | 25x |

#### 最终奖励公式

```
最终奖励 = 基础奖励 × 稀有度倍数 × 连击倍数
```

**示例**：
- 基础奖励 = 10 BONK
- 捕获传说 Rocket（25x）+ 5 连击金网（2x）
- 最终奖励 = 10 × 25 × 2 = **500 BONK**

---

### 2.5 项目方价值交换

| 价值类型 | 描述 |
|----------|------|
| **品牌曝光** | 房间内展示项目 Logo、代币信息 |
| **社交传播** | 用户完成社交任务作为参与门槛 |
| **数据收集** | 收集参与用户钱包地址 |
| **广告植入** | 房间可自定义背景、公告等 |

---

## 三、架构设计

### 3.1 职责分离

```
┌─────────────────────────────────────────────────────────────┐
│                      系统架构                                │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  ┌──────────────┐     ┌──────────────┐     ┌──────────────┐ │
│  │   前端       │     │   后端       │     │   合约       │ │
│  │              │     │              │     │ (最小化)     │ │
│  │ - 游戏渲染   │ ←→  │ - 游戏逻辑   │ ←→  │              │ │
│  │ - 动画效果   │     │ - 连击状态   │     │ - 奖池托管   │ │
│  │ - 冷却可视化 │     │ - 冷却计时   │     │ - Token发放  │ │
│  │ - 社交任务UI │     │ - 随机数生成 │     │              │ │
│  └──────────────┘     │ - 社交验证   │     └──────────────┘ │
│                       └──────────────┘                      │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

### 3.2 合约精简

**移除**：
- 网大小费用逻辑 (`NET_COST_SMALL/MEDIUM/LARGE`)
- 用户付费逻辑 (`require(msg.value >= cost)`)
- 费用分配逻辑 (`90% 入池, 10% 给 owner`)
- 链上随机数逻辑（移至后端）

**保留/新增**：
- 奖池托管 (`depositToPool`)
- Token 发放 (`transferReward`)
- 房间创建/结算
- 项目方权限管理

### 3.3 Solana/Anchor 合约接口

> [!IMPORTANT]
> 已确认迁移至 Solana，清除旧 EVM 合约

```rust
#[program]
pub mod meme_hunter {
    // 创建房间
    pub fn create_room(ctx: Context<CreateRoom>, config: RoomConfig) -> Result<()>;
    
    // 项目方充值奖池 (SPL Token)
    pub fn deposit_pool(ctx: Context<DepositPool>, amount: u64) -> Result<()>;
    
    // 后端签名发放奖励
    pub fn claim_reward(ctx: Context<ClaimReward>, amount: u64, sig: [u8; 64]) -> Result<()>;
    
    // 结算房间，退还剩余代币
    pub fn settle_room(ctx: Context<SettleRoom>) -> Result<()>;
}
```

---

## 四、数据模型变更

### 4.1 后端新增数据

```typescript
// 玩家游戏状态（内存/Redis）
interface PlayerGameState {
  playerId: string;
  roomId: string;
  comboCount: number;        // 当前连击数
  netLevel: 'normal' | 'silver' | 'gold' | 'diamond';
  cooldownMs: number;        // 当前冷却时间 (2000-5000)
  lastHuntTime: number;      // 上次狩猎时间戳
  pendingRewards: number;    // 待领取奖励
}

// 房间配置
interface RoomConfig {
  roomId: string;
  tokenMint: string;
  tokenSymbol: string;
  poolBalance: number;
  duration: number;
  socialTasks: SocialTask[];  // 社交任务列表
  branding: {
    logo: string;
    banner: string;
    announcement: string;
  };
}
```

---

## 五、前端变更清单

| 模块 | 变更内容 |
|------|----------|
| **ControlBar** | 移除网选择器，添加连击显示、冷却进度条 |
| **GameCanvas** | 添加网等级视觉效果、升级动画 |
| **RewardPopup** | 显示连击加成、稀有度加成明细 |
| **SocialTaskPanel** | 新增社交任务列表和完成状态 |
| **RoomInfo** | 显示项目方 Branding 信息 |

---

## 六、验证计划

### 6.1 单元测试
- 后端连击逻辑测试
- 冷却时间计算测试
- 奖励公式计算测试

### 6.2 集成测试
- 创建房间 → 多人狩猎 → 结算完整流程
- 社交任务验证流程

### 6.3 用户体验测试
- 冷却可视化效果是否流畅
- 连击升级动画是否有惊喜感
- 奖励弹窗是否清晰展示加成明细

---

## 七、已确认参数

| 参数 | 确认值 |
|------|--------|
| 冷却时间 | 5秒→2秒 ✅ |
| 连击等级 | 3/5/10 ✅ |
| 稀有度概率 | 50%/30%/15%/5% ✅ |
| 社交任务 | 仅 Twitter ✅ |
| 合约框架 | Solana/Anchor ✅ |
| 用户留存目标 | 4-7 分钟 ✅ |

---

## 变更记录

| 日期 | 变更内容 |
|------|----------|
| 2026-01-27 | 初始设计，基于头脑风暴讨论结果 |
| 2026-01-27 | 用户确认参数，迁移至 Solana，调整稀有度 |
| 2026-01-27 | ✅ **Hunt 后端化实施完成** - 移除链上 `hunt.rs`，清理 EVM 遗留代码 |
